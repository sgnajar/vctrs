<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prototypes and sizes • vctrs</title>
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min.js" integrity="sha256-hIvIxeqhGZF+VVeM55k0mJvWpQ6gTkWk3Emc+NmowYA=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prototypes and sizes">
<meta property="og:description" content="">
<meta property="og:image" content="https://vctrs.r-lib.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vctrs</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/s3-vector.html">S3 vectors</a>
    </li>
    <li>
      <a href="../articles/stability.html">Type and size stability</a>
    </li>
    <li>
      <a href="../articles/type-size.html">Prototypes and sizes</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/vctrs">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Prototypes and sizes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/master/vignettes/type-size.Rmd"><code>vignettes/type-size.Rmd</code></a></small>
      <div class="hidden name"><code>type-size.Rmd</code></div>

    </div>

    
    
<p>Rather than using <code>class()</code> and <code>length()</code>, vctrs has notions of prototype (<code><a href="../reference/vec_type.html">vec_ptype()</a></code>) and size (<code><a href="../reference/vec_size.html">vec_size()</a></code>). This vignette motivates why these alternatives are necessary, and connects their definitions to type coercion and the recycling rules.</p>
<p>Size and prototype are motivated by thinking about the optimal behaviour for <code>c()</code> and <code>rbind()</code>, particularly inspired by data frames with columns that are matrices or data frames.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(vctrs)</a></code></pre></div>
<div id="prototype" class="section level2">
<h2 class="hasAnchor">
<a href="#prototype" class="anchor"></a>Prototype</h2>
<p>The idea of a prototype is to capture the metadata associated with a vector, without capturing any data. Unfortunately, the <code>class()</code> of an object is inadequate for this purpose:</p>
<ul>
<li><p>The <code>class()</code> doesn’t include attributes. Attributes are important because, for example, they store the levels of a factor, and the timezone of a <code>POSIXct</code>. You can not combine two factors or two <code>POSIXct</code>s without thinking about the attribute.</p></li>
<li><p>The <code>class()</code> of a matrix is “matrix”, and doesn’t include the type of the underlying vector, or the dimesnionality.</p></li>
</ul>
<p>Instead vctrs takes advantage of R’s vectorised nature and uses a <strong>prototype</strong>, a 0-observation slice of the vector (this is basically <code>x[0]</code> but with some subtleties we’ll come back to later) . This is a miniature version of the vector that contains all of the attributes but none of the data.</p>
<p>Conveniently, you can create many prototypes using existing base functions (e.g, <code>double()</code>, <code>factor(levels = c("a", "b"))</code>). vctrs provides a few helpers (e.g. <code><a href="../reference/new_date.html">new_date()</a></code>, <code><a href="../reference/new_date.html">new_datetime()</a></code>, <code><a href="../reference/new_date.html">new_duration()</a></code>) where the equivalents in base R are missing.</p>
<div id="base-prototypes" class="section level3">
<h3 class="hasAnchor">
<a href="#base-prototypes" class="anchor"></a>Base prototypes</h3>
<p><code><a href="../reference/vec_type.html">vec_type()</a></code> creates a prototype from an existing object. However, many base vectors have uninformative printing methods for 0-length subsets, so vctrs also provides <code><a href="../reference/vec_type.html">vec_ptype()</a></code>, which prints the prototype in a friendly way (and returns nothing).</p>
<p>Using <code><a href="../reference/vec_type.html">vec_ptype()</a></code> allows us to see the prototypes base R classes:.</p>
<ul>
<li>
<p>Atomic vectors have no attributes, and just display the underlying <code>typeof()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; Prototype: logical</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(1L)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#&gt; Prototype: integer</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt; Prototype: double</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="st">"three"</span>)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt; Prototype: character</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">list</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#&gt; Prototype: list</span></a></code></pre></div>
</li>
<li>
<p>The prototype of matrices and arrays include the base type, and the dimensions after the first:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">array</span>(<span class="kw">logical</span>(), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; Prototype: logical[,3]</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">array</span>(<span class="kw">integer</span>(), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; Prototype: integer[,3,4]</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">array</span>(<span class="kw">character</span>(), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)))</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; Prototype: character[,3,4,5]</span></a></code></pre></div>
</li>
<li>
<p>The prototype of a factor includes its levels. Levels are a character vector, which can be arbitrarily long, so the prototype just shows a hash. If the hash of two factors is equal it’s higly likely that their levels are also equal.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">factor</span>(<span class="st">"a"</span>))</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; Prototype: factor&lt;127a2&gt;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">ordered</span>(<span class="st">"b"</span>))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; Prototype: ordered&lt;ddf10&gt;</span></a></code></pre></div>
<p>While <code><a href="../reference/vec_type.html">vec_ptype()</a></code> prints only the hash, the prototype object itself does contain all levels:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_type</a></span>(<span class="kw">factor</span>(<span class="st">"a"</span>))</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; factor(0)</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; Levels: a</span></a></code></pre></div>
</li>
<li>
<p>Base R has three key date time classes: dates, date-times (<code>POSIXct</code>), and durations (<code>difftime)</code>. Date-times have a timezone, and durations have a unit.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">Sys.Date</span>())</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; Prototype: date</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">Sys.time</span>())</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; Prototype: datetime&lt;local&gt;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">as.difftime</span>(<span class="dv">10</span>, <span class="dt">units =</span> <span class="st">"mins"</span>))</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; Prototype: duration&lt;mins&gt;</span></a></code></pre></div>
</li>
<li>
<p>Data frames have the most complex prototype: the prototype of a data frame is the name and prototype of each column:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">data.frame</span>(<span class="dt">a =</span> <span class="ot">FALSE</span>, <span class="dt">b =</span> 1L, <span class="dt">c =</span> <span class="fl">2.5</span>, <span class="dt">d =</span> <span class="st">"x"</span>))</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; Prototype: data.frame&lt;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt;   a: logical</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt;   b: integer</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt;   c: double</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt;   d: factor&lt;5a425&gt;</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; &gt;</span></a></code></pre></div>
<p>Data frames can have columns that are themselves data frames, making this a “recursive” type:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">df<span class="op">$</span>y &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a =</span> 1L, <span class="dt">b =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(df)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt; Prototype: data.frame&lt;</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;   x: logical</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt;   y: </span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;     data.frame&lt;</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;       a: integer</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt;       b: double</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt;     &gt;</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt; &gt;</span></a></code></pre></div>
</li>
</ul>
</div>
<div id="coercing-to-common-type" class="section level3">
<h3 class="hasAnchor">
<a href="#coercing-to-common-type" class="anchor"></a>Coercing to common type</h3>
<p>It’s often important to combine vectors with multiple types. vctrs provides a consistent set of rules for coercion, via <code><a href="../reference/vec_type.html">vec_type_common()</a></code>. <code><a href="../reference/vec_type.html">vec_type_common()</a></code> possesses the following invariants:</p>
<ul>
<li><p><code>class(vec_type_common(x, y))</code> equals <code>class(vec_type_common(y, x))</code>.</p></li>
<li><p><code>class(vec_type_common(x, vec_type_common(y, z))</code> equals <code>class(vec_type_common(vec_type_common(x, y)))</code>.</p></li>
<li><p><code>vec_type_common(x, NULL) == x</code>.</p></li>
</ul>
<p>i.e. <code><a href="../reference/vec_type.html">vec_type_common()</a></code> is both commutative and associative (with respect to class), and has an identity element, <code>NULL</code>, i.e. it’s a <strong>commutative monoid</strong>. This means the underlying implementation is quite simple: we can find the common type of any number of objects by progressively finding the common type of pairs of objects.</p>
<p>Like with <code><a href="../reference/vec_type.html">vec_type()</a></code>, the easiest way to explore <code><a href="../reference/vec_type.html">vec_type_common()</a></code> is with <code><a href="../reference/vec_type.html">vec_ptype()</a></code>: when given multiple inputs, it will print their common prototype. (In other words: program with <code><a href="../reference/vec_type.html">vec_type_common()</a></code> but play with <code><a href="../reference/vec_type.html">vec_ptype()</a></code>.)</p>
<ul>
<li>
<p>The common type of atomic vectors is computed very similar to rules of base R, except that we do not coerce to character automatically:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">logical</span>(), <span class="kw">integer</span>(), <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; Prototype: &lt;double&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; 0. (           , &lt;logical&gt; ) = &lt;logical&gt;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; 1. ( &lt;logical&gt; , &lt;integer&gt; ) = &lt;integer&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; 2. ( &lt;integer&gt; , &lt;double&gt;  ) = &lt;double&gt;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">logical</span>(), <span class="kw">character</span>())</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; Error: No common type for &lt;logical&gt; and &lt;character&gt;</span></a></code></pre></div>
</li>
<li>
<p>Matrices and arrays are automatically broadcast to higher dimensions:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), </a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; Prototype: &lt;double[,2]&gt;</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt; 0. (              , &lt;double[,1]&gt; ) = &lt;double[,1]&gt;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; 1. ( &lt;double[,1]&gt; , &lt;double[,2]&gt; ) = &lt;double[,2]&gt;</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), </a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>)),</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>)),</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#&gt; Prototype: &lt;double[,3,4,5]&gt;</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">#&gt; 0. (                , &lt;double[,1]&gt;     ) = &lt;double[,1]&gt;    </span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">#&gt; 1. ( &lt;double[,1]&gt;   , &lt;double[,3]&gt;     ) = &lt;double[,3]&gt;    </span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#&gt; 2. ( &lt;double[,3]&gt;   , &lt;double[,3,4]&gt;   ) = &lt;double[,3,4]&gt;  </span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#&gt; 3. ( &lt;double[,3,4]&gt; , &lt;double[,3,4,5]&gt; ) = &lt;double[,3,4,5]&gt;</span></a></code></pre></div>
<p>Provided that the dimensions follow the vctrs recycling rules:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)), </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; Error: Incompatible lengths: 2, 3</span></a></code></pre></div>
</li>
<li>
<p>Factors combine levels in the order in which they appear.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">fa &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="st">"a"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">fb &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="st">"b"</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw">levels</span>(<span class="kw"><a href="../reference/vec_type.html">vec_type_common</a></span>(fa, fb))</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; [1] "a" "b"</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw">levels</span>(<span class="kw"><a href="../reference/vec_type.html">vec_type_common</a></span>(fb, fa))</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; [1] "b" "a"</span></a></code></pre></div>
</li>
<li>
<p>Combining a date and date-time yields a date-time:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw"><a href="../reference/new_date.html">new_date</a></span>(), <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>())</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; Prototype: &lt;datetime&lt;local&gt;&gt;</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; 0. (        , &lt;date&gt;            ) = &lt;date&gt;           </span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; 1. ( &lt;date&gt; , &lt;datetime&lt;local&gt;&gt; ) = &lt;datetime&lt;local&gt;&gt;</span></a></code></pre></div>
<p>When combining two date times, the timezone is taken from the first input:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>(<span class="dt">tzone =</span> <span class="st">"US/Central"</span>), </a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>(<span class="dt">tzone =</span> <span class="st">"Pacific/Auckland"</span>)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co">#&gt; Prototype: &lt;datetime&lt;US/Central&gt;&gt;</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; 0. (                        , &lt;datetime&lt;US/Central&gt;&gt;       ) = &lt;datetime&lt;US/Central&gt;&gt;</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; 1. ( &lt;datetime&lt;US/Central&gt;&gt; , &lt;datetime&lt;Pacific/Auckland&gt;&gt; ) = &lt;datetime&lt;US/Central&gt;&gt;</span></a></code></pre></div>
<p>Unless it’s the local timezone, in which case any explicit time zone will win:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>(<span class="dt">tzone =</span> <span class="st">""</span>), </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>(<span class="dt">tzone =</span> <span class="st">""</span>), </a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="kw"><a href="../reference/new_date.html">new_datetime</a></span>(<span class="dt">tzone =</span> <span class="st">"Pacific/Auckland"</span>)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; Prototype: &lt;datetime&lt;Pacific/Auckland&gt;&gt;</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; 0. (                   , &lt;datetime&lt;local&gt;&gt;            ) = &lt;datetime&lt;local&gt;&gt;           </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; 1. ( &lt;datetime&lt;local&gt;&gt; , &lt;datetime&lt;local&gt;&gt;            ) = &lt;datetime&lt;local&gt;&gt;           </span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt; 2. ( &lt;datetime&lt;local&gt;&gt; , &lt;datetime&lt;Pacific/Auckland&gt;&gt; ) = &lt;datetime&lt;Pacific/Auckland&gt;&gt;</span></a></code></pre></div>
</li>
<li>
<p>The common type of two data frames is the common type of each column that occurs in both data frames:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="ot">FALSE</span>), </a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  <span class="kw">data.frame</span>(<span class="dt">x =</span> 1L),</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt; Prototype: &lt;data.frame&lt;x:double&gt;&gt;</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; 0. (                         , &lt;data.frame&lt;x:logical&gt;&gt; ) = &lt;data.frame&lt;x:logical&gt;&gt;</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt; 1. ( &lt;data.frame&lt;x:logical&gt;&gt; , &lt;data.frame&lt;x:integer&gt;&gt; ) = &lt;data.frame&lt;x:integer&gt;&gt;</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#&gt; 2. ( &lt;data.frame&lt;x:integer&gt;&gt; , &lt;data.frame&lt;x:double&gt;&gt;  ) = &lt;data.frame&lt;x:double&gt;&gt;</span></a></code></pre></div>
<p>And the union of the columns that only occur in one:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="../reference/vec_type.html">vec_ptype</a></span>(<span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">1</span>), <span class="kw">data.frame</span>(<span class="dt">y =</span> <span class="dv">1</span>, <span class="dt">z =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co">#&gt; Prototype: &lt;data.frame&lt;</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co">#&gt;   x: double</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co">#&gt;   y: double</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co">#&gt;   z: double</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt; &gt;&gt;</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt; 0. ┌              , &lt;data.frame&lt; ┐ = &lt;data.frame&lt;</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt;    │                  x: double  │     x: double </span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt;    │                  y: double  │     y: double </span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="co">#&gt;    └                &gt;&gt;           ┘   &gt;&gt;          </span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co">#&gt; 1. ┌ &lt;data.frame&lt; , &lt;data.frame&lt; ┐ = &lt;data.frame&lt;</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="co">#&gt;    │   x: double      y: double  │     x: double </span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="co">#&gt;    │   y: double      z: double  │     y: double </span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="co">#&gt;    │ &gt;&gt;             &gt;&gt;           │     z: double </span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="co">#&gt;    └                             ┘   &gt;&gt;</span></a></code></pre></div>
<p>Note that new columns are added on the right-hand side. This is consistent with the way that factor levels and time zones are handled.</p>
</li>
</ul>
</div>
<div id="casting-to-specified-type" class="section level3">
<h3 class="hasAnchor">
<a href="#casting-to-specified-type" class="anchor"></a>Casting to specified type</h3>
<p><code><a href="../reference/vec_type.html">vec_type_common()</a></code> finds the common type of a set of vector. Typically, however, what you want is a set of vectors coerced to that common type. That’s the job of <code><a href="../reference/vec_cast.html">vec_cast_common()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">str</span>(<span class="kw"><a href="../reference/vec_cast.html">vec_cast_common</a></span>(</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  <span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb18-3" data-line-number="3">  <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, </a>
<a class="sourceLine" id="cb18-4" data-line-number="4">  <span class="fl">2.5</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">))</a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co">#&gt; List of 3</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="co">#&gt;  $ : num 0</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt;  $ : num [1:5] 1 2 3 4 5</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="co">#&gt;  $ : num 2.5</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="kw">str</span>(<span class="kw"><a href="../reference/vec_cast.html">vec_cast_common</a></span>(</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">  <span class="kw">factor</span>(<span class="st">"x"</span>), </a>
<a class="sourceLine" id="cb18-13" data-line-number="13">  <span class="kw">factor</span>(<span class="st">"y"</span>)</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">))</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="co">#&gt;  $ : Factor w/ 2 levels "x","y": 1</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17"><span class="co">#&gt;  $ : Factor w/ 2 levels "x","y": 2</span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18"></a>
<a class="sourceLine" id="cb18-19" data-line-number="19"><span class="kw">str</span>(<span class="kw"><a href="../reference/vec_cast.html">vec_cast_common</a></span>(</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">  <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">  <span class="kw">data.frame</span>(<span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">))</a>
<a class="sourceLine" id="cb18-23" data-line-number="23"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb18-24" data-line-number="24"><span class="co">#&gt;  $ :'data.frame':    1 obs. of  2 variables:</span></a>
<a class="sourceLine" id="cb18-25" data-line-number="25"><span class="co">#&gt;   ..$ x: num 1</span></a>
<a class="sourceLine" id="cb18-26" data-line-number="26"><span class="co">#&gt;   ..$ y: int NA</span></a>
<a class="sourceLine" id="cb18-27" data-line-number="27"><span class="co">#&gt;  $ :'data.frame':    2 obs. of  2 variables:</span></a>
<a class="sourceLine" id="cb18-28" data-line-number="28"><span class="co">#&gt;   ..$ x: num [1:2] NA NA</span></a>
<a class="sourceLine" id="cb18-29" data-line-number="29"><span class="co">#&gt;   ..$ y: int [1:2] 1 2</span></a></code></pre></div>
<p>Alternatively, you can cast to a specific prototype using <code><a href="../reference/vec_cast.html">vec_cast()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># Cast succeeds</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co">#&gt; [1] 1 2</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co"># Cast fails</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(<span class="fl">1.5</span>, <span class="fl">2.5</span>), <span class="kw">factor</span>(<span class="st">"a"</span>))</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; Error: Can't cast &lt;double&gt; to &lt;factor&lt;127a2&gt;&gt;</span></a></code></pre></div>
<p>If a cast is possible in general (i.e. double -&gt; integer), but information is lost for a specific input (e.g. 1.5 -&gt; 1), it will generate a warning.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>), <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co">#&gt; Warning: Lossy cast from &lt;double&gt; to &lt;integer&gt;</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="co">#&gt; Locations: 1</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#&gt; [1] 1 2</span></a></code></pre></div>
<p>The set of casts is more permissive than the set of coercions and is summarised in the diagram below. Coercions are shown by arrows; possible casts are shown with circles.</p>
<div class="figure">
<img src="../man/figures/combined.png" alt="Summary of vctrs casting rules"><p class="caption">Summary of vctrs casting rules</p>
</div>
</div>
</div>
<div id="size" class="section level2">
<h2 class="hasAnchor">
<a href="#size" class="anchor"></a>Size</h2>
<p><code><a href="../reference/vec_size.html">vec_size()</a></code> was motivated by the need to have an invariant that describes the number of “observations” in a data structure. This is particularly important for data frames as it’s useful to have some function such that <code>f(data.frame(x))</code> equals <code>f(x)</code>. No base function has this property:</p>
<ul>
<li><p><code>length(data.frame(x))</code> equals <code>1</code>, because the length of a data frame is the number of columns.</p></li>
<li><p><code>nrow(data.frame(x))</code> does not equal <code>nrow(x)</code>, because <code>nrow()</code> of a vector is <code>NULL</code>.</p></li>
<li><p><code>NROW(data.frame(x))</code> equals <code>NROW(x)</code> for vector <code>x</code>, so is almost what we want. But because <code>NROW()</code> is defined in terms of <code>length()</code>, it returns a value for every object, even types that can’t go in a data frame, e.g. <code>data.frame(mean)</code> errors even though <code>NROW(mean)</code> is <code>1</code>.</p></li>
</ul>
<p>We define <code><a href="../reference/vec_size.html">vec_size()</a></code> as follows:</p>
<ul>
<li>It is the length of 1d vectors</li>
<li>It is the number of rows of data frames, matrices, and arrays.</li>
<li>It throws error for non vectors.</li>
</ul>
<p>Given <code><a href="../reference/vec_size.html">vec_size()</a></code>, we can give a precise definition of a data frame: a data frame is a list of vectors where every vector has the same size. This has the desirable property of trivially supporting matrix and data frame columns.</p>
<div id="slicing" class="section level3">
<h3 class="hasAnchor">
<a href="#slicing" class="anchor"></a>Slicing</h3>
<p><code><a href="../reference/vec_slice.html">vec_slice()</a></code> is to <code><a href="../reference/vec_size.html">vec_size()</a></code> as <code>[</code> is to <code>length()</code>; i.e. it allows you to select observations, regardless of the dimensionality of the underlying object. <code><a href="../reference/vec_slice.html">vec_slice(x, i)</a></code> is equivalent to:</p>
<ul>
<li>
<code>x[i]</code> when <code>x</code> is a vector.</li>
<li>
<code>x[i, , drop = FALSE]</code> when <code>x</code> is a data frame.</li>
<li>
<code>x[i, , , drop = FALSE]</code> when <code>x</code> is a 3d array.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> x)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="kw"><a href="../reference/vec_slice.html">vec_slice</a></span>(x, <span class="dv">5</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">#&gt; [1] 9 3</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="kw"><a href="../reference/vec_slice.html">vec_slice</a></span>(df, <span class="dv">5</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#&gt;   x</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="co">#&gt; 1 9</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="co">#&gt; 2 3</span></a></code></pre></div>
<p><code><a href="../reference/vec_slice.html">vec_slice(data.frame(x), i)</a></code> equals <code>data.frame(vec_slice(x, i))</code> (modulo variable and row names).</p>
<p>Prototypes are generated with <code><a href="../reference/vec_slice.html">vec_slice(x, 0L)</a></code>; given a prototype, you can generate a vector of given size (filled with <code>NA</code>s) with <code><a href="../reference/vec_na.html">vec_na()</a></code></p>
</div>
<div id="common-sizes-recycling-rules" class="section level3">
<h3 class="hasAnchor">
<a href="#common-sizes-recycling-rules" class="anchor"></a>Common sizes: recycling rules</h3>
<p>Closely related to the definition of size are the <strong>recycling rules</strong>. The recycling rules determine the size of the output when two vectors of different sizes are combined. In vctrs, the recycling rules are encoded in <code><a href="../reference/vec_size.html">vec_size_common()</a></code> which give the common size of a set of vectors:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="../reference/vec_size.html">vec_size_common</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="kw"><a href="../reference/vec_size.html">vec_size_common</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="kw"><a href="../reference/vec_size.html">vec_size_common</a></span>(<span class="kw">integer</span>(), <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt; [1] 0</span></a></code></pre></div>
<p>vctrs obeys a stricter set of recylcing rules than base R, only recycling under two circumstances:</p>
<ul>
<li>Vectors of size 1 can be recycled to any size.</li>
<li>Vectors of any size can be recylced to size 0.</li>
</ul>
<p>All other size combinations will generate an error. This strictness prevents common mistakes like <code>dest == c("IAH", "HOU"))</code>, at the cost of occassionally requiring an explicit calls to <code>rep()</code>.</p>
<div class="figure">
<img src="../man/figures/sizes-recycling.png" alt="Summary of vctrs recycling rules. X indicates n error"><p class="caption">Summary of vctrs recycling rules. X indicates n error</p>
</div>
<p>You can apply the recycling rules in two ways:</p>
<ul>
<li>
<p>If you have a vector and desired size, use <code><a href="../reference/vec_recycle.html">vec_recycle()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="co">#&gt; [1] 1 2 3</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(<span class="dv">1</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="co">#&gt; integer(0)</span></a></code></pre></div>
</li>
<li>
<p>If you have multiple vectors and you want to recycle them to the same size, use <code><a href="../reference/vec_recycle.html">vec_recycle_common()</a></code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="co">#&gt; [1] 1 2 3</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="co">#&gt; [1] 1 2 3</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span>(<span class="kw">integer</span>(), <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb24-14" data-line-number="14"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb24-15" data-line-number="15"><span class="co">#&gt; integer(0)</span></a>
<a class="sourceLine" id="cb24-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-17" data-line-number="17"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb24-18" data-line-number="18"><span class="co">#&gt; integer(0)</span></a></code></pre></div>
</li>
</ul>
</div>
</div>
<div id="appendix-recycling-in-base-r" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix-recycling-in-base-r" class="anchor"></a>Appendix: recycling in base R</h2>
<p>The recycling rules in base R are described in <a href="https://cran.r-project.org/doc/manuals/r-release/R-lang.html#Recycling-rules">The R Language Definition</a> but are not implemented in a single function, and thus are not applied consistently. Here I give a brief overview of their most common realisation, as well as showing some of the exceptions.</p>
<p>Generally, in base R, when a pair of vectors is not the same length, the shorter vector is recycled to the same length as the longer:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="co">#&gt; [1] 2 2 2 2 2 2</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="co">#&gt; [1] 2 3 2 3 2 3</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="co">#&gt; [1] 2 3 4 2 3 4</span></a></code></pre></div>
<p>If the length of the longer vector is not an integer multiple of the length of the shorter, you usually get a warning:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">invisible</span>(<span class="kw">pmax</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co">#&gt; Warning in pmax(1:2, 1:3): an argument will be fractionally recycled</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="kw">invisible</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="co">#&gt; Warning in 1:2 + 1:3: longer object length is not a multiple of shorter</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="co">#&gt; object length</span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6"><span class="kw">invisible</span>(<span class="kw">cbind</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb26-7" data-line-number="7"><span class="co">#&gt; Warning in cbind(1:2, 1:3): number of rows of result is not a multiple of</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="co">#&gt; vector length (arg 1)</span></a></code></pre></div>
<p>But some functions recycle silently:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">length</span>(<span class="kw">atan2</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">length</span>(<span class="kw">paste</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="kw">length</span>(<span class="kw">ifelse</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="co">#&gt; [1] 3</span></a></code></pre></div>
<p>And <code>data.frame()</code> throws an error:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">data.frame</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="co">#&gt; Error in data.frame(1:2, 1:3): arguments imply differing number of rows: 2, 3</span></a></code></pre></div>
<p>The R language definition states that “any arithmetic operation involving a zero-length vector has a zero-length result”. But outside of arithmetic, this rule is not consistently followed:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co"># length-0 output</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="kw">integer</span>()</a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co">#&gt; integer(0)</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="kw">atan2</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="co">#&gt; numeric(0)</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="kw">pmax</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co">#&gt; integer(0)</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8"></a>
<a class="sourceLine" id="cb29-9" data-line-number="9"><span class="co"># dropped</span></a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="kw">cbind</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb29-11" data-line-number="11"><span class="co">#&gt;      [,1]</span></a>
<a class="sourceLine" id="cb29-12" data-line-number="12"><span class="co">#&gt; [1,]    1</span></a>
<a class="sourceLine" id="cb29-13" data-line-number="13"><span class="co">#&gt; [2,]    2</span></a>
<a class="sourceLine" id="cb29-14" data-line-number="14"></a>
<a class="sourceLine" id="cb29-15" data-line-number="15"><span class="co"># recycled to length of first</span></a>
<a class="sourceLine" id="cb29-16" data-line-number="16"><span class="kw">ifelse</span>(<span class="kw">rep</span>(<span class="ot">TRUE</span>, <span class="dv">4</span>), <span class="kw">integer</span>(), <span class="kw">character</span>())</a>
<a class="sourceLine" id="cb29-17" data-line-number="17"><span class="co">#&gt; [1] NA NA NA NA</span></a>
<a class="sourceLine" id="cb29-18" data-line-number="18"></a>
<a class="sourceLine" id="cb29-19" data-line-number="19"><span class="co"># preserved-ish</span></a>
<a class="sourceLine" id="cb29-20" data-line-number="20"><span class="kw">paste</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb29-21" data-line-number="21"><span class="co">#&gt; [1] "1 " "2 "</span></a>
<a class="sourceLine" id="cb29-22" data-line-number="22"></a>
<a class="sourceLine" id="cb29-23" data-line-number="23"><span class="co"># Errors</span></a>
<a class="sourceLine" id="cb29-24" data-line-number="24"><span class="kw">data.frame</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb29-25" data-line-number="25"><span class="co">#&gt; Error in data.frame(1:2, integer()): arguments imply differing number of rows: 2, 0</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prototype">Prototype</a></li>
      <li><a href="#size">Size</a></li>
      <li><a href="#appendix-recycling-in-base-r">Appendix: recycling in base R</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
